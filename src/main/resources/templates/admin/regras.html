<!DOCTYPE html>
<html th:replace="~{admin/base :: layout('Regras de Visitação', ~{::section})}" xmlns:th="http://www.thymeleaf.org">
<section>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <style>
        .content-wrapper { padding: 2rem; }
        @media (max-width: 768px){ .content-wrapper { padding: 1.5rem 1rem; } }
        .editor-container { background: var(--surface); border: 1px solid var(--line); border-radius: 14px; padding: 24px; }
        #editor { height: 350px; font-family: 'Inter', sans-serif; font-size: 16px; }
        .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; border-color: var(--line) !important; }
        .ql-container { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-color: var(--line) !important; }
        .editor-actions {
            position: sticky; bottom: 0; background: var(--surface); padding: 16px 24px;
            border-top: 1px solid var(--line); margin: 0 -24px -24px -24px;
            border-bottom-left-radius: 14px; border-bottom-right-radius: 14px;
        }
    </style>

    <div class="content-wrapper">
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <form id="form-regras" th:action="@{/admin/regras}" th:object="${regra}" method="post">
            <div class="editor-container">
                <div class="mb-3">
                    <label for="titulo" class="form-label fw-bold">Título</label>
                    <input type="text" class="form-control form-control-lg" id="titulo" th:field="*{titulo}"
                           th:classappend="${#fields.hasErrors('titulo')} ? 'is-invalid' : ''" />
                    <div th:if="${#fields.hasErrors('titulo')}" class="invalid-feedback" th:errors="*{titulo}"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Conteúdo</label>
                    <div id="editor"></div>
                    <input type="hidden" id="conteudo-hidden" th:field="*{conteudo}" />
                    <div th:if="${#fields.hasErrors('conteudo')}" class="d-block invalid-feedback" th:errors="*{conteudo}"></div>
                </div>

                <div class="editor-actions d-flex justify-content-end gap-2">
                    <button type="reset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> Cancelar Alterações</button>
                    <button type="submit" class="btn btn-primary" style="background-color: var(--brand); border-color: var(--brand);"><i class="bi bi-check-lg"></i> Salvar Regras</button>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-regras');
            const hiddenInput = document.getElementById('conteudo-hidden');
            const initialContent = /*[[${regra.conteudo}]]*/ '';

            const toolbarOptions = [
                [{ 'font': ['sans-serif', 'serif'] }], [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'], [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }], ['link'], ['clean']
            ];

            const quill = new Quill('#editor', { modules: { toolbar: toolbarOptions }, theme: 'snow', placeholder: 'Comece a digitar as regras aqui...' });
            quill.clipboard.dangerouslyPasteHTML(initialContent);

            form.addEventListener('submit', function (e) {
                const rawHtml = quill.root.innerHTML;
                hiddenInput.value = DOMPurify.sanitize(rawHtml, { USE_PROFILES: {html: true}, ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3', 'ol', 'ul', 'li', 'a', 'span'], ALLOWED_ATTR: ['href', 'target', 'style', 'class'] });
            });

            form.addEventListener('reset', function(e) {
                setTimeout(() => quill.clipboard.dangerouslyPasteHTML(initialContent), 0);
            });
        });
    </script>
</section>
</html>