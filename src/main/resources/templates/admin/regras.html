<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${pageTitle} ?: 'Regras de Visitação'">Regras de Visitação</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />

    <style>
        :root{
          --brand:#294A5D;
          --accent:#A7532C;
          --olive:#556B2F;
          --beige:#F4F1EA;
          --ink:#1A202C;
          --muted:#718096;
          --surface:#FFFFFF;
          --line:#E5E7EB;
          --bg:#F0F5FA;
          --soft:#f9fafb;
        }
        html,body{height:100%;}
        body{
          font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          color:var(--ink);
          background-color: var(--bg);
        }
        .app{ display:grid; grid-template-columns: 280px 1fr; min-height:100vh; }
        @media (max-width: 991.98px){ .app{ grid-template-columns: 1fr; } .sidebar{ display: none; } }
        .sidebar{ background: linear-gradient(180deg, #ffffff, #fafafa 70%); border-right:1px solid var(--line); display: flex; flex-direction: column; }
        .brand{ padding:24px 20px; border-bottom:1px solid var(--line); }
        .brand h1{ font-size:22px; letter-spacing:.6px; margin:0; color:var(--brand); font-weight:800; text-transform:uppercase; }
        .menu-section{ padding:16px 14px 8px; color:var(--muted); font-weight:600; text-transform:uppercase; font-size:12px; }
        .nav-item + .nav-item{ margin-top:8px; }
        .nav-link{ display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; color:var(--ink); background:var(--surface); border:1px solid var(--line); transition: all .18s ease; text-decoration:none; font-weight:500; }
        .nav-link:hover{ transform: translateY(-1px); box-shadow:0 6px 14px -8px rgba(0,0,0,.15); border-color:#dfe3e8; }
        .nav-link .bi{ font-size:18px; color:var(--brand); }
        .nav-link.active{ border-color: color-mix(in oklab, var(--brand) 28%, white); background: color-mix(in oklab, var(--brand) 8%, white); box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--brand) 20%, transparent); font-weight: 600; }
        .sidebar-footer{ margin-top:auto; padding:16px; border-top:1px solid var(--line); }
        .user-card{ display:flex; gap:12px; align-items:center; padding:12px; border:1px solid var(--line); border-radius:12px; background:var(--surface); }
        .avatar{ width:36px; height:36px; border-radius:50%; display:grid; place-items:center; border:1px solid var(--line); background: color-mix(in oklab, var(--brand) 12%, white); color:var(--brand); font-weight:700; }
        .topbar{ padding:16px 24px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); background: rgba(255,255,255,.65); backdrop-filter: blur(8px); position:sticky; top:0; z-index:10; }
        .title{ margin:0; font-size:24px; font-weight:700; color:var(--brand); }

        /* Estilos da 'main' e 'content' */
        main.content-wrapper {
          flex-grow: 1;
          padding: 2rem;
        }
        @media (max-width: 768px){ main.content-wrapper { padding: 1.5rem 1rem; } }

        /* Estilos do Editor */
        .editor-container {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 24px;
        }
        #editor {
            height: 350px; /* Altura do editor */
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }
        .ql-toolbar {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-color: var(--line) !important;
        }
        .ql-container {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            border-color: var(--line) !important;
        }
        .editor-actions {
            position: sticky;
            bottom: 0;
            background: var(--surface);
            padding: 16px 24px;
            border-top: 1px solid var(--line);
            margin: 0 -24px -24px -24px; /* "Puxa" para o rodapé do card */
            border-bottom-left-radius: 14px;
            border-bottom-right-radius: 14px;
        }
    </style>
</head>

<body>
<div class="app">

    <aside class="sidebar d-none d-lg-flex flex-column">
        <div class="brand">
            <h1>VISITA<br/>BRENNAND</h1>
        </div>
        <div class="px-3 pt-3">
            <div class="menu-section">Principal</div>
            <nav class="nav flex-column">
                <div class="nav-item"><a class="nav-link" th:href="@{/admin/avisos}"><i class="bi bi-bell"></i> Avisos</a></div>
                <div class="nav-item"><a class="nav-link" th:href="@{/admin/horarios}"><i class="bi bi-clock"></i> Horários</a></div>
                <div class="nav-item"><a class="nav-link active" th:href="@{/admin/regras}"><i class="bi bi-journal-check"></i> Regras</a></div>
            </nav>
            <div class="menu-section">Gestão</div>
            <nav class="nav flex-column mb-4">
                <div class="nav-item"><a class="nav-link" th:href="@{/admin/feedbacks}"><i class="bi bi-chat-square-heart"></i> Feedbacks</a></div>
                <div class="nav-item"><a class="nav-link" th:href="@{/admin/relatorios}"><i class="bi bi-graph-up"></i> Relatórios</a></div>
            </nav>
        </div>
        <div class="sidebar-footer">
            <div class="user-card mb-2">
                <div class="avatar">A</div>
                <div class="small">
                    <div class="fw-semibold">Administrador</div>
                    <div class="text-muted">@admin</div>
                </div>
            </div>
            <a class="btn btn-outline-secondary w-100" th:href="@{/logout}"><i class="bi bi-box-arrow-left me-1"></i> Sair</a>
        </div>
    </aside>

    <main class="d-flex flex-column">

        <div class="topbar">
            <button class="btn d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu"><i class="bi bi-list fs-3"></i></button>
            <h2 class="title d-none d-lg-block" th:text="${pageTitle}">Editar Regras</h2>
            <a class="btn btn-sm btn-outline-secondary" th:href="@{/}"><i class="bi bi-house me-1"></i> Ver site</a>
        </div>

        <section class="content-wrapper">

            <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <form id="form-regras" th:action="@{/admin/regras}" th:object="${regra}" method="post">
                <div class="editor-container">

                    <div class="mb-3">
                        <label for="titulo" class="form-label fw-bold">Título</label>
                        <input type="text" class="form-control form-control-lg"
                               id="titulo" th:field="*{titulo}"
                               th:classappend="${#fields.hasErrors('titulo')} ? 'is-invalid' : ''" />
                        <div th:if="${#fields.hasErrors('titulo')}" class="invalid-feedback" th:errors="*{titulo}"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Conteúdo</label>

                        <div id="editor">
                        </div>

                        <input type="hidden" id="conteudo-hidden" th:field="*{conteudo}" />
                        <div th:if="${#fields.hasErrors('conteudo')}"
                             class="d-block invalid-feedback" th:errors="*{conteudo}"></div>
                    </div>

                    <div class="editor-actions d-flex justify-content-end gap-2">
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i> Cancelar Alterações
                        </button>
                        <button type="submit" class="btn btn-primary" style="background-color: var(--brand); border-color: var(--brand);">
                            <i class="bi bi-check-lg"></i> Salvar Regras
                        </button>
                    </div>
                </div>
            </form>

        </section>
    </main>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileMenu">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="menu-section">Principal</div>
        <nav class="nav flex-column">
            <div class="nav-item"><a class="nav-link" th:href="@{/admin/avisos}"><i class="bi bi-bell"></i> Avisos</a></div>
            <div class="nav-item"><a class="nav-link" th:href="@{/admin/horarios}"><i class="bi bi-clock"></i> Horários</a></div>
            <div class="nav-item"><a class="nav-link active" th:href="@{/admin/regras}"><i class="bi bi-journal-check"></i> Regras</a></div>
        </nav>
        <div class="menu-section">Gestão</div>
        <nav class="nav flex-column mb-4">
            <div class="nav-item"><a class="nav-link" th:href="@{/admin/feedbacks}"><i class="bi bi-chat-square-heart"></i> Feedbacks</a></div>
            <div class="nav-item"><a class="nav-link" th:href="@{/admin/relatorios}"><i class="bi bi-graph-up"></i> Relatórios</a></div>
        </nav>
        <hr/>
        <a class="btn btn-outline-secondary w-100" th:href="@{/logout}"><i class="bi bi-box-arrow-left me-1"></i> Sair</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>


<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {

        // 1. Pega os elementos do formulário
        const form = document.getElementById('form-regras');
        const hiddenInput = document.getElementById('conteudo-hidden');

        // Pega o conteúdo inicial (sanitizado) vindo do Model
        const initialContent = /*[[${regra.conteudo}]]*/ '';

        // 2. Configura a barra de ferramentas (Toolbar)
        const toolbarOptions = [
            // Fontes (limitadas)
            [{ 'font': ['sans-serif', 'serif'] }],
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }],
            ['link'],
            ['clean']
        ];

        // 3. Inicializa o Quill
        const quill = new Quill('#editor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow', // Tema padrão com a barra de ferramentas
            placeholder: 'Comece a digitar as regras aqui...'
        });

        // 4. Carrega o conteúdo do banco de dados no editor
        quill.clipboard.dangerouslyPasteHTML(initialContent);


        // 5. LÓGICA DE SALVAR (COM DOMPURIFY)
        form.addEventListener('submit', function (e) {
            // Pega o HTML de dentro do editor
            const rawHtml = quill.root.innerHTML;

            // **NOVO:** Sanitiza o HTML antes de enviar
            // Permite tags de formatação e links http/https
            const cleanHtml = DOMPurify.sanitize(rawHtml, {
                USE_PROFILES: {html: true},
                ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3', 'ol', 'ul', 'li', 'a', 'span'],
                ALLOWED_ATTR: ['href', 'target', 'style', 'class'] // Permite estilos básicos e classes
            });

            // Copia o HTML LIMPO para o input escondido
            hiddenInput.value = cleanHtml;
        });

        // 6. LÓGICA DE CANCELAR:
        form.addEventListener('reset', function(e) {
            // Recarrega o conteúdo original no editor
            quill.clipboard.dangerouslyPasteHTML(initialContent);
        });
    });
</script>

</body>
</html>