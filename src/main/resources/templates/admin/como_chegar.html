<!DOCTYPE html>
<html th:replace="~{admin/base :: layout('Editar Como Chegar', ~{::section})}" xmlns:th="http://www.thymeleaf.org">
<section>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <style>
        .editor-container { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 24px; }
        #editor { height: 350px; font-family: 'Inter', sans-serif; font-size: 16px; }
        .editor-actions { margin-top: 16px; display: flex; justify-content: flex-end; gap: 10px; }
    </style>

    <div class="container mt-4">
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <form id="form-conteudo" th:action="@{/admin/como-chegar}" th:object="${comoChegar}" method="post">
            <div class="editor-container">
                <div class="mb-3">
                    <label class="form-label fw-bold">Conteúdo Informativo</label>

                    <div id="editor"></div>

                    <input type="hidden" id="conteudo-hidden" th:field="*{conteudo}" />

                    <div th:if="${#fields.hasErrors('conteudo')}" class="d-block invalid-feedback" th:errors="*{conteudo}"></div>
                </div>
                <div class="editor-actions">
                    <button type="submit" class="btn btn-primary" style="background-color: var(--brand);">Salvar Alterações</button>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <script th:inline="none">
        document.addEventListener('DOMContentLoaded', function () {

            // Configuração da Barra de Ferramentas
            const toolbarOptions = [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'clean']
            ];

            // Inicializa o Quill
            const quill = new Quill('#editor', {
                theme: 'snow',
                modules: { toolbar: toolbarOptions },
                placeholder: 'Digite as informações de transporte, valores e rotas...'
            });

            // 1. Carrega o conteúdo inicial lendo direto do input hidden
            // Isso evita erros de parsing do Thymeleaf
            const hiddenInput = document.getElementById('conteudo-hidden');
            if (hiddenInput.value) {
                quill.clipboard.dangerouslyPasteHTML(hiddenInput.value);
            }

            // 2. Ao enviar o formulário, copia o HTML do editor de volta para o input
            const form = document.getElementById('form-conteudo');
            form.addEventListener('submit', function (e) {
                // Sanitiza o HTML antes de enviar (segurança)
                hiddenInput.value = DOMPurify.sanitize(quill.root.innerHTML);
            });
        });
    </script>
</section>
</html>