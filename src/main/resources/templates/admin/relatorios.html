<!DOCTYPE html>
<html th:replace="~{admin/base :: layout('Relatórios', ~{::section})}" xmlns:th="http://www.thymeleaf.org">
<section>
    <link rel="stylesheet" th:href="@{/relatorio-feedbacks/styles.css}" href="/relatorio-feedbacks/styles.css">
    <style>
        .report-shell { width:100%; padding: 20px; }
        .report-header { text-align:center; margin-bottom:24px; }
        .report-header h1{ font-size:1.8rem; color:#294A5D; font-weight: 800; }

        /* Ajuste nos cards */
        .report-stat-card { transition: transform 0.2s; }
        .report-stat-card:hover { transform: translateY(-3px); }
    </style>

    <div class="report-shell container-fluid">
        <div class="report-header">
            <h1>Relatório de Feedbacks</h1>
            <p class="text-muted">Indicadores em tempo real baseados nos dados dos visitantes</p>
        </div>

        <div class="report-stats-grid">
            <div class="report-stat-card">
                <h3>Média Geral</h3>
                <div class="report-stat-value" th:text="${media}">0.0</div>
                <div class="report-stat-sub">
                    <span th:if="${media != '0.0'}" style="color:#f6c343; letter-spacing:2px;">
                        ★★★★★
                    </span>
                    <span th:if="${media == '0.0'}" class="text-muted small">Sem dados</span>
                </div>
            </div>
            <div class="report-stat-card">
                <h3>Total de Feedbacks</h3>
                <div class="report-stat-value" th:text="${total}">0</div>
                <div class="report-stat-label">registros totais</div>
            </div>
            <div class="report-stat-card">
                <h3>Satisfação</h3>
                <div class="report-stat-value" th:text="${satisfacao} + '%'">0%</div>
                <div class="report-stat-label">avaliações positivas (4 ou 5)</div>
            </div>
        </div>

        <div class="report-charts-grid">
            <div class="report-chart-card">
                <h3>Avaliações por Estrelas</h3>
                <canvas id="starsChart"></canvas>
            </div>
            <div class="report-chart-card">
                <h3>Evolução da Média (6 Meses)</h3>
                <canvas id="timelineChart"></canvas>
            </div>
        </div>

        <div class="report-chart-card report-full">
            <h3>Feedbacks por Tipo</h3>
            <div style="height: 250px;">
                <canvas id="typesChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // Recuperando dados do Model Java
        const estrelasData = /*[[${estrelasData}]]*/ [0,0,0,0,0];
        const timelineLabels = /*[[${timelineLabels}]]*/ ['Jan','Fev'];
        const timelineData = /*[[${timelineData}]]*/ [0,0];
        const tiposData = /*[[${tiposData}]]*/ [0,0];

        // Configuração de Cores
        const brandColor = '#294A5D';
        const accentColor = '#A7532C';

        // 1. Gráfico de Estrelas (Barra)
        new Chart(document.getElementById('starsChart'), {
            type: 'bar',
            data: {
                labels: ['1★', '2★', '3★', '4★', '5★'],
                datasets: [{
                    label: 'Quantidade',
                    data: estrelasData,
                    backgroundColor: [
                        '#ef4444', // 1 star (red)
                        '#f97316', // 2 stars (orange)
                        '#eab308', // 3 stars (yellow)
                        '#84cc16', // 4 stars (light green)
                        '#22c55e'  // 5 stars (green)
                    ],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // 2. Gráfico de Linha do Tempo
        new Chart(document.getElementById('timelineChart'), {
            type: 'line',
            data: {
                labels: timelineLabels,
                datasets: [{
                    label: 'Nota Média',
                    data: timelineData,
                    borderColor: brandColor,
                    backgroundColor: 'rgba(41, 74, 93, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: brandColor
                }]
            },
            options: {
                responsive: true,
                scales: { y: { min: 0, max: 5 } }
            }
        });

        // 3. Gráfico de Tipos (Horizontal Bar)
        new Chart(document.getElementById('typesChart'), {
            type: 'bar',
            data: {
                labels: ['Sugestões', 'Reclamações'],
                datasets: [{
                    label: 'Total',
                    data: tiposData,
                    backgroundColor: ['#0ea5e9', '#ef4444'],
                    barThickness: 40,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y', // Barra horizontal
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        /*]]>*/
    </script>
</section>
</html>