<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/base :: layout('Relatórios', ~{::section})}">
<section>
    <link rel="stylesheet" th:href="@{/relatorio-feedbacks/styles.css}" href="/relatorio-feedbacks/styles.css">

    <style>
        /* CORREÇÃO AQUI: Adicionei max-width e margin auto para centralizar */
        .report-shell {
            width: 100%;
            max-width: 1100px; /* Trava a largura para não esticar infinitamente */
            margin: 0 auto;    /* Centraliza na tela */
            padding: 0;
            background: transparent;
        }

        .report-chart-card, .report-stat-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            border: 1px solid #eef2f6;
            padding: 20px;
        }

        .report-chart-card h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--brand);
            margin-bottom: 1rem;
        }

        /* Containers para controlar o tamanho do Canvas */
        .chart-box {
            position: relative;
            height: 300px; /* Aumentei um pouco a altura para dar respiro */
            width: 100%;
        }

        .chart-box-sm {
            position: relative;
            height: 200px; /* Aumentei um pouco a altura */
            width: 100%;
        }
    </style>

    <div id="conteudo-principal" class="container-fluid">

        <div class="report-shell mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold m-0" style="color: var(--brand);">Relatórios</h2>
                <p class="text-muted small m-0">Acompanhamento de métricas e indicadores</p>
            </div>
            <div>
                <a th:href="@{/admin/avisos}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-lg"></i> Novo Aviso
                </a>
            </div>
        </div>

        <div class="report-shell">

            <div class="report-stats-grid mb-4">
                <div class="report-stat-card">
                    <h3 class="text-muted text-uppercase" style="font-size: 0.75rem;">Média Geral</h3>
                    <div class="d-flex align-items-baseline gap-2">
                        <div class="report-stat-value display-6 fw-bold" th:text="${media}" style="color: var(--brand);">0.0</div>
                        <div class="report-stat-sub">
                            <span th:if="${media != '0.0'}" style="color:#f59e0b;">★★★★★</span>
                            <span th:if="${media == '0.0'}" class="text-muted small">Sem dados</span>
                        </div>
                    </div>
                </div>
                <div class="report-stat-card">
                    <h3 class="text-muted text-uppercase" style="font-size: 0.75rem;">Total de Feedbacks</h3>
                    <div class="report-stat-value display-6 fw-bold" th:text="${total}" style="color: var(--brand);">0</div>
                    <div class="small text-muted">registros totais</div>
                </div>
                <div class="report-stat-card">
                    <h3 class="text-muted text-uppercase" style="font-size: 0.75rem;">Satisfação</h3>
                    <div class="report-stat-value display-6 fw-bold" th:text="${satisfacao} + '%'" style="color: #10b981;">0%</div>
                    <div class="small text-muted">avaliações positivas</div>
                </div>
            </div>

            <div class="report-charts-grid">
                <div class="report-chart-card">
                    <h3>Avaliações por Estrelas</h3>
                    <div class="chart-box">
                        <canvas id="starsChart"></canvas>
                    </div>
                </div>
                <div class="report-chart-card">
                    <h3>Evolução da Média (6 Meses)</h3>
                    <div class="chart-box">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="report-chart-card report-full mt-4">
                <h3>Feedbacks por Tipo</h3>
                <div class="chart-box-sm">
                    <canvas id="typesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Recuperando dados do Model Java
        const estrelasData = /*[[${estrelasData}]]*/ [0,0,0,0,0];
        const timelineLabels = /*[[${timelineLabels}]]*/ ['Jan','Fev'];
        const timelineData = /*[[${timelineData}]]*/ [0,0];
        const tiposData = /*[[${tiposData}]]*/ [0,0];

        const brandColor = '#294A5D';
        const gridColor = '#f3f4f6';

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';

        // 1. Gráfico de Estrelas
        new Chart(document.getElementById('starsChart'), {
            type: 'bar',
            data: {
                labels: ['1★', '2★', '3★', '4★', '5★'],
                datasets: [{
                    label: 'Quantidade',
                    data: estrelasData,
                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
                    borderRadius: 6,
                    maxBarThickness: 50
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: gridColor, borderDash: [5, 5] }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. Gráfico de Linha do Tempo
        new Chart(document.getElementById('timelineChart'), {
            type: 'line',
            data: {
                labels: timelineLabels,
                datasets: [{
                    label: 'Nota Média',
                    data: timelineData,
                    borderColor: brandColor,
                    backgroundColor: 'rgba(41, 74, 93, 0.05)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: brandColor,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        min: 0, max: 5,
                        grid: { color: gridColor, borderDash: [5, 5] }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Gráfico de Tipos
        new Chart(document.getElementById('typesChart'), {
            type: 'bar',
            data: {
                labels: ['Sugestões', 'Reclamações'],
                datasets: [{
                    label: 'Total',
                    data: tiposData,
                    backgroundColor: ['#3b82f6', '#ef4444'],
                    barThickness: 35,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: gridColor, borderDash: [5, 5] }
                    },
                    y: { grid: { display: false } }
                }
            }
        });
        /*]]>*/
    </script>
</section>
</html>